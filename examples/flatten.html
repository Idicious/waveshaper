<!DOCTYPE>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1 initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="HandheldFriendly" content="true">
    <style>
        #canvas-container {
            height: 90%;
            overflow-y: scroll;
            transform: translateZ(0);
        }

        svg {
            shape-rendering: auto;
        }

        #canvas-wrapper {
            width: 100%;
        }

        #timeline {
            width: 100%;
            height: 50px;
        }

        #canvas-fragment {
            width: 100%;
        }

        .canvas-fragment {
            width: 100%;
        }

        #virtual-scroll-container {
            width: 99%;
        }

        #virtual-scroll {
            transform: translateZ(0);
            overflow-x: scroll;
        }

        #virtual-scroll-width {
            height: 1px;
        }
    </style>
</head>

<body>
    <!-- <canvas id="timeline"></canvas> -->
    <div id="canvas-container">
        <div id="canvas-wrapper">
            <div id="canvas-fragment"></div>
        </div>
    </div>

    <div id="virtual-scroll-container">
        <div id="virtual-scroll">
            <div id="virtual-scroll-width">
            </div>
        </div>
    </div>
    <div id="duration"></div>
    <div id="samples-per-pixel"></div>
    <button id="zoom-in">Zoom In</button>
    <button id="zoom-out">Zoom Out</button>
    <select id="mode">
        <option value="pan" selected>Pan</option>
        <option value="drag">Drag</option>
        <option value="resize">Resize</option>
        <option value="cut">Cut</option>
    </select>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.js"></script>
    <script src="../waveshaper.js"></script>
    <script>
        const audioContext = new AudioContext();
        const canvasContainer = document.getElementById('canvas-container');
        const options = {
            scrollPosition: 0,
            samplesPerPixel: 1024,
            resolution: 10,
            meterType: 'peak',
            mode: 'pan',
            height: 300,
            width: canvasContainer.clientWidth,
            samplerate: audioContext.sampleRate,
            generateId: function() { return Math.random().toString(); }
        }
        
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const canvasFragment = document.getElementById('canvas-fragment');

        const manager = new WaveShaper.DomRenderWaveShapeManager(options);
        WaveShaper.addInteraction(manager, 'canvas-wrapper');

        const elementHeight = options.height;
        const ownHeight = canvasContainer.clientHeight;
        const fitInElement = Math.ceil(ownHeight / elementHeight);

        const buffers = [];
        let buffersInView = [];
        const subscriptions = [];

        const loadAudio = (key, url) => {
            fetch(url)
            .then(res => res.arrayBuffer())
            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
            .then(audioBuffer => {
                manager.addData({ id: key, data: audioBuffer }).process();
            })
            .catch(e => console.error(e));
        }

        loadAudio('1', '/examples/audio/GTR.WAV');
        loadAudio('2', '/examples/audio/TOM.WAV');
        loadAudio('3', '/examples/audio/13_ElecGtr01.mp3');

        for(let i = 0; i < 100; i++) {
            const segments = [{
                    id: "" + Math.random(),
                    start: 0,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 0,
                    source: "1"
                },
                {
                    id: "" + Math.random(),
                    start: 5,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 1,
                    source: "2"
                },
                {
                    id: "" + Math.random(),
                    start: 10,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 2,
                    source: "3"
                },
                {
                    id: "" + Math.random(),
                    start: 23,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 3,
                    source: "1"
                },
                {
                    id: "" + Math.random(),
                    start: 24,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 4,
                    source: "2"
                },
                {
                    id: "" + Math.random(),
                    start: 35,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 5,
                    source: "3"
                }
            ]

            var waveShapeData = {
                id: i.toString(),
                segments,
                canvas: document.createElement('canvas'),
                color: '#f5f5f5'
            };

            buffers.push(waveShapeData);
            const waveShaper = manager.setTracks({ id: waveShapeData.id, segments: waveShapeData.segments });
            canvasWrapper.style.height = buffers.length * elementHeight + 'px';
            
            if (buffers.length <= fitInElement) {
                buffersInView.push(waveShapeData);
                
                const subscription = manager.registerCanvas(waveShapeData.id, waveShapeData.canvas, waveShapeData.color);
                subscriptions.push(subscription);

                canvasFragment.appendChild(waveShapeData.canvas);
                
                manager.setActive(...buffersInView.map(b => b.id));
                requestAnimationFrame(() => manager.process());
            }
        }

        var durationDiv = document.getElementById('duration');
        var duration = manager.getDurationAsDate();
        durationDiv.innerText = 'Duration: ' + duration.getMinutes() + ' : ' + duration.getSeconds() +
            ' : ' + duration.getMilliseconds();

        var sppDiv = document.getElementById('samples-per-pixel');
        sppDiv.innerText = 'Samples per pixel: ' + options.samplesPerPixel;

        // Set scroll width to the total draw length of the audio file
        var scroller = document.getElementById('virtual-scroll-width');
        scroller.style.width = manager.getScrollWidth() + 'px';

        let lastVirtualScroll = false;
        document.getElementById('virtual-scroll').addEventListener('scroll', function (e) {
            if(lastVirtualScroll) return;
            
            lastVirtualScroll = true;
            requestAnimationFrame(() => {
                manager.set({ scrollPosition: e.target.scrollLeft }).process();
                lastVirtualScroll = false;
            });
        });

        let lastStartIndex = 0;
        let lastScroll = false;
        document.getElementById('canvas-container').addEventListener('scroll', function (e) {
            if(lastScroll) return;

            const scrollHeight = e.target.scrollTop;
            const startIndex = Math.floor(scrollHeight / elementHeight);
            const offset = startIndex * elementHeight;

            if (startIndex === lastStartIndex) {
                return;
            }
            
            lastScroll = true;

            // Unsubscribe to existing canvas draw callbacks
            while(subscriptions.length > 0) subscriptions.pop()();

            const containerDiv = document.createElement('div');
            containerDiv.style.transform = 'translateY(' + offset + 'px)';
            containerDiv.classList.add('canvas-fragment');

            const inView = buffersInView.length;
            buffersInView = buffers.slice(startIndex, startIndex + fitInElement);
            manager.setActive(...buffersInView.map(b => b.id));

            for(const buffer of buffersInView) {
                const sub = manager.registerCanvas(buffer.id, buffer.canvas, buffer.color);
                subscriptions.push(sub);

                containerDiv.appendChild(buffer.canvas);
            }

            const oldNode = canvasWrapper.firstChild;
            canvasWrapper.replaceChild(containerDiv, oldNode);
            
            lastStartIndex = startIndex;
            requestAnimationFrame(() => {
                manager.process();
                lastScroll = false;
            });
        });

        document.getElementById('zoom-in').addEventListener('click', function (e) {
            const { samplesPerPixel } = manager.options;
            var newZoom = samplesPerPixel / 2;

            sppDiv.innerText = 'Samples per pixel: ' + newZoom;

            requestAnimationFrame(() => {
                manager.set({ samplesPerPixel: newZoom }).process();
                scroller.style.width = manager.getScrollWidth() + 'px';
            });
        });

        document.getElementById('zoom-out').addEventListener('click', function (e) {
            const { samplesPerPixel } = manager.options;
            var newZoom = samplesPerPixel * 2;

            sppDiv.innerText = 'Samples per pixel: ' + newZoom;

            requestAnimationFrame(() => {
                manager.set({ samplesPerPixel: newZoom }).process();
                scroller.style.width = manager.getScrollWidth() + 'px';
            });
        });

        document.getElementById('mode').addEventListener('change', function(e) {
            manager.set({mode: e.target.value}).process();
        });
    </script>
</body>

</html>