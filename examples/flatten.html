<!DOCTYPE>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1 initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="HandheldFriendly" content="true">
    <style>
        #canvas-container {
            height: 90%;
            overflow-y: scroll;
            transform: translateZ(0);
        }

        svg {
            shape-rendering: auto;
        }

        #canvas-wrapper {
            width: 100%;
        }

        #timeline {
            width: 100%;
            height: 50px;
        }

        #canvas-fragment {
            width: 100%;
        }

        .canvas-fragment {
            width: 100%;
        }

        #virtual-scroll-container {
            width: 99%;
        }

        #virtual-scroll {
            transform: translateZ(0);
            overflow-x: scroll;
        }

        #virtual-scroll-width {
            height: 1px;
        }
    </style>
</head>

<body>
    <!-- <canvas id="timeline"></canvas> -->
    <div id="canvas-container">
        <div id="canvas-wrapper">
            <div id="canvas-fragment"></div>
        </div>
    </div>

    <div id="virtual-scroll-container">
        <div id="virtual-scroll">
            <div id="virtual-scroll-width">
            </div>
        </div>
    </div>
    <div id="duration"></div>
    <div id="samples-per-pixel"></div>
    <button id="zoom-in">Zoom In</button>
    <button id="zoom-out">Zoom Out</button>
    <select id="mode">
        <option value="pan" selected>Pan</option>
        <option value="drag">Drag</option>
        <option value="resize">Resize</option>
        <option value="cut">Cut</option>
    </select>

    <script src="../index.js"></script>
    <script>
        const audioContext = new AudioContext();
        const canvasContainer = document.getElementById('canvas-container');
        const options = {
            scrollPosition: 0,
            samplesPerPixel: 1024,
            resolution: 10,
            meterType: 'peak',
            mode: 'pan',
            height: 300,
            width: canvasContainer.clientWidth,
            generateId: function() { return Math.random().toString(); }
        }
        

        //const schedular = new Schedular(16, audioContext);
        //schedular.start();
        
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const canvasFragment = document.getElementById('canvas-fragment');

        const manager = new WaveShapeManager(audioContext.sampleRate, canvasWrapper, options);

        const elementHeight = options.height;
        const ownHeight = canvasContainer.clientHeight;
        const fitInElement = Math.ceil(ownHeight / elementHeight);

        const buffers = [];
        let buffersInView = [];

        const loadAudio = (key, url) => {
            fetch(url)
            .then(res => res.arrayBuffer())
            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
            .then(audioBuffer => {
                manager.addAudioData(key, audioBuffer);
            })
            .catch(e => console.error(e));
        }

        loadAudio('1', '/examples/audio/GTR.WAV');
        loadAudio('2', '/examples/audio/TOM.WAV');
        loadAudio('3', '/examples/audio/13_ElecGtr01.mp3');

        for(let i = 0; i < 100; i++) {
            const segments = [{
                    id: "" + Math.random(),
                    start: 0,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 0,
                    source: "1"
                },
                {
                    id: "" + Math.random(),
                    start: 5,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 1,
                    source: "2"
                },
                {
                    id: "" + Math.random(),
                    start: 10,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 2,
                    source: "3"
                },
                {
                    id: "" + Math.random(),
                    start: 23,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 3,
                    source: "1"
                },
                {
                    id: "" + Math.random(),
                    start: 24,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 4,
                    source: "2"
                },
                {
                    id: "" + Math.random(),
                    start: 35,
                    duration: 136,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 5,
                    source: "3"
                }
            ]

            var waveShapeData = {
                id: i.toString(),
                segments,
                color: '#f5f5f5'
            };

            buffers.push(waveShapeData);
            const waveShaper = manager.addWaveShaper(waveShapeData.id, waveShapeData.segments, waveShapeData.color);
            canvasWrapper.style.height = buffers.length * elementHeight + 'px';

            if (buffers.length <= fitInElement) {
                buffersInView.push(waveShapeData);
                canvasFragment.appendChild(waveShaper.element);
                
                manager.activeWaveShapers = buffersInView.map(b => b.id);
                requestAnimationFrame(() => manager.draw());
            }
        }

        var durationDiv = document.getElementById('duration');
        var duration = manager.getDurationAsDate();
        durationDiv.innerText = 'Duration: ' + duration.getMinutes() + ' : ' + duration.getSeconds() +
            ' : ' + duration.getMilliseconds();

        var sppDiv = document.getElementById('samples-per-pixel');
        sppDiv.innerText = 'Samples per pixel: ' + manager.samplesPerPixel;

        // Set scroll width to the total draw length of the audio file
        var scroller = document.getElementById('virtual-scroll-width');
        scroller.style.width = manager.getScrollWidth() + 'px';

        //const scrollHandle = schedular.getHandle();
        document.getElementById('virtual-scroll').addEventListener('scroll', function (e) {
            manager.scrollPosition = e.target.scrollLeft;

            requestAnimationFrame(() => manager.draw());
        });

        let lastStartIndex = 0;
        //let handle = schedular.getHandle();
        document.getElementById('canvas-container').addEventListener('scroll', function (e) {
            const scrollHeight = e.target.scrollTop;
            const startIndex = Math.floor(scrollHeight / elementHeight);
            const offset = startIndex * elementHeight;

            if (startIndex === lastStartIndex) {
                return;
            }

            const containerDiv = document.createElement('div');
            containerDiv.style.transform = 'translateY(' + offset + 'px)';
            containerDiv.classList.add('canvas-fragment');

            const oldNode = canvasWrapper.firstChild;
            canvasWrapper.replaceChild(containerDiv, oldNode);

            const inView = buffersInView.length;
            buffersInView = buffers.slice(startIndex, startIndex + fitInElement);
            manager.activeWaveShapers = buffersInView.map(b => b.id);

            for(const buffer of buffersInView) {
               const waveShaper = manager.getWaveShaper(buffer.id);
               if(waveShaper != null) {
                containerDiv.appendChild(waveShaper.element);
               }
            }

            requestAnimationFrame(() => manager.draw());
            lastStartIndex = startIndex;
        });

        document.getElementById('zoom-in').addEventListener('click', function (e) {
            var currentZoom = manager.samplesPerPixel;
            var newZoom = currentZoom / 2;

            manager.samplesPerPixel = newZoom;

            sppDiv.innerText = 'Samples per pixel: ' + manager.samplesPerPixel;
            scroller.style.width = manager.getScrollWidth() + 'px';

            requestAnimationFrame(() => manager.draw());
        });

        document.getElementById('zoom-out').addEventListener('click', function (e) {
            var currentZoom = manager.samplesPerPixel;
            var newZoom = currentZoom * 2;

            manager.samplesPerPixel = newZoom;

            sppDiv.innerText = 'Samples per pixel: ' + manager.samplesPerPixel;
            scroller.style.width = manager.getScrollWidth() + 'px';

            requestAnimationFrame(() => manager.draw());
        });

        document.getElementById('mode').addEventListener('change', function(e) {
            manager.mode = e.target.value;
        });
    </script>
</body>

</html>