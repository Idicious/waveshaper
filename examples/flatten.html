<!DOCTYPE>
<html>

<head>
    <style>
        .testCanvas {
            width: 100%;
            height: 150px;
            background-color: yellow;
            image-rendering: optimizeSpeed;
        }

        #canvas-container {
            height: 90%;
            overflow-y: scroll;
            transform: translateZ(0);
        }

        #canvas-wrapper {
            width: 100%;
        }

        #timeline {
            width: 100%;
            height: 50px;
        }

        #canvas-fragment {
            width: 100%;
        }

        .canvas-fragment {
            width: 100%;
        }

        #virtual-scroll-container {
            width: 99%;
        }

        #virtual-scroll {
            transform: translateZ(0);
            overflow-x: scroll;
        }

        #virtual-scroll-width {
            height: 1px;
        }
    </style>
</head>

<body>
    <!-- <canvas id="timeline"></canvas> -->
    <div id="canvas-container">
        <div id="canvas-wrapper">
            <div id="canvas-fragment"></div>
        </div>
    </div>

    <div id="virtual-scroll-container">
        <div id="virtual-scroll">
            <div id="virtual-scroll-width">
            </div>
        </div>
    </div>
    <div id="duration"></div>
    <div id="samples-per-pixel"></div>
    <button id="zoom-in">Zoom In</button>
    <button id="zoom-out">Zoom Out</button>

    <script src="/waveshaper.bundle.js"></script>
    <script>
        const audioContext = new AudioContext();
        const options = {
            scrollPosition: 0,
            samplesPerPixel: 1024,
            resolution: 32,
            drawStyle: 'fill',
            meterType: 'peak'
        }

        //const timelineCanvas = document.getElementById('timeline');
        //timelineCanvas.width = timelineCanvas.clientWidth;
        //timelineCanvas.height = timelineCanvas.clientHeight;
        //const timelineCtx = timelineCanvas.getContext('2d');

        const width = window.outerWidth;
        const height = 50;

        // const drawTimeLine = function(spp, sr, w, h, sp) {
        //     const secondsPerPixel = (spp / sr);
        //     const pixelsPerSecond = 1 / secondsPerPixel;
        //     const secondsInWindow = Math.ceil(secondsPerPixel * w);
        //     const secondsFromStart = (sp * secondsPerPixel) % 1;
        //     const pixelsFromStart = secondsFromStart * pixelsPerSecond;

        //     timelineCtx.clearRect(0, 0, w, h);
        //     for(let i = 0; i <= secondsInWindow; i++) {
        //         const pixel = Math.floor((i * pixelsPerSecond) + pixelsFromStart);
        //         timelineCtx.fillRect(pixel, 0, 1, h);
        //     }
        // }
        // drawTimeLine(options.samplesPerPixel, audioContext.sampleRate, width, height, 0);
        

        const schedular = new Schedular(16, audioContext);
        schedular.start();

        
        
        const canvasContainer = document.getElementById('canvas-container');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const canvasFragment = document.getElementById('canvas-fragment');

        const manager = new WaveShapeManager(audioContext.sampleRate, canvasWrapper, options);

        const elementHeight = 150;
        const ownHeight = canvasContainer.clientHeight;
        const fitInElement = Math.ceil(ownHeight / elementHeight);

        const buffers = [];
        let buffersInView = [];
        const worker = new Worker('/examples/workers/audio-worker.js');
        worker.onmessage = (message) => {
            const buffer = getAudioBuffer(message.data.buffer, message.data.meta);
            const canvas = document.createElement('canvas');
            canvas.classList.add('testCanvas');

            var data = buffer.getChannelData(0);
            var duration = data.length / audioContext.sampleRate;
            var segments = [{
                    id: "" + Math.random(),
                    start: 0,
                    duration: duration,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 0,
                    data: data
                },
                {
                    id: "" + Math.random(),
                    start: 5,
                    duration: duration,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 1,
                    data: data
                },
                {
                    id: "" + Math.random(),
                    start: 10,
                    duration: duration,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 1,
                    data: data
                },
                {
                    id: "" + Math.random(),
                    start: 23,
                    duration: duration,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 1,
                    data: data
                },
                {
                    id: "" + Math.random(),
                    start: 24,
                    duration: duration,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 0,
                    data: data
                },
                {
                    id: "" + Math.random(),
                    start: 35,
                    duration: duration,
                    offsetStart: 10,
                    offsetEnd: 0,
                    index: 2,
                    data: data
                }
            ]

            var waveShapeData = {
                id: Math.random(),
                canvas,
                segments
            };
            buffers.push(waveShapeData);

            canvasWrapper.style.height = buffers.length * elementHeight + 'px';
            if (buffers.length <= fitInElement) {
                buffersInView.push(waveShapeData);
                canvasFragment.appendChild(waveShapeData.canvas);
                manager.addWave(waveShapeData.id, waveShapeData.canvas, waveShapeData.segments);
                requestAnimationFrame(() => manager.draw([waveShapeData.id]));
            }
        }
        for (var i = 0; i < 100; i++) {
            worker.postMessage('/examples/audio/GTR.WAV');
        }

        const getAudioBuffer = (buffer, meta) => {
            const audioBuf = audioContext.createBuffer(meta.channels, meta.length, meta.sampleRate);
            for (var i = 0; i < meta.channels; i++) {
                const channelData = new Float32Array(buffer[i]);
                audioBuf.copyToChannel(channelData, i);
            }
            return audioBuf;
        }



        var durationDiv = document.getElementById('duration');
        var duration = manager.getDurationAsDate();
        durationDiv.innerText = 'Duration: ' + duration.getMinutes() + ' : ' + duration.getSeconds() +
            ' : ' + duration.getMilliseconds();

        var sppDiv = document.getElementById('samples-per-pixel');
        sppDiv.innerText = 'Samples per pixel: ' + manager.samplesPerPixel;

        // Set scroll width to the total draw length of the audio file
        var scroller = document.getElementById('virtual-scroll-width');
        scroller.style.width = manager.getScrollWidth() + 'px';

        //var currentAnimation;
        // Add a listener to the scrollable element for virtual scroll
        let scrollHandles = schedular.getHandles(fitInElement);
        document.getElementById('virtual-scroll').addEventListener('scroll', function (e) {
            manager.scrollPosition = e.target.scrollLeft;
            var bufs = buffers.slice(lastStartIndex, lastStartIndex + fitInElement).map(buf => buf.id);

            // requestAnimationFrame(() => {
            //     drawTimeLine(manager.samplesPerPixel, audioContext.sampleRate, width, height, manager.scrollPosition);
            //     manager.draw(bufs);
            // })
            
            //drawTimeLine(manager.samplesPerPixel, audioContext.sampleRate, width, height, manager.scrollPosition);
            for(let i = 0; i < bufs.length; i++) {
                const handle = scrollHandles[i];
                const buf = bufs[i];

                handle.addJob(() => manager.draw([buf]));
            }
        });

        let lastStartIndex = 0;
        let handles = [];
        document.getElementById('canvas-container').addEventListener('scroll', function (e) {
            const scrollHeight = e.target.scrollTop;
            const startIndex = Math.floor(scrollHeight / elementHeight);
            const offset = startIndex * elementHeight;

            if (startIndex === lastStartIndex) {
                return;
            }

            const containerDiv = document.createElement('div');
            containerDiv.style.transform = 'translateY(' + offset + 'px)';
            containerDiv.classList.add('canvas-fragment');

            const oldNode = canvasWrapper.firstChild;
            canvasWrapper.replaceChild(containerDiv, oldNode);

            buffersInView = buffers.slice(startIndex, startIndex + fitInElement);
            for(const buffer of buffersInView) {
               containerDiv.appendChild(buffer.canvas);
               manager.addWave(buffer.id, buffer.canvas, buffer.segments);
            }
            //manager.draw(buffersInView.map(b => b.id));

            for(let i = 0; i < buffersInView.length; i++) {
                const handle = scrollHandles[i];
                const buf = buffersInView[i];

                handle.addJob(() => manager.draw([buf.id]));
            }

            lastStartIndex = startIndex;
        });

        document.getElementById('zoom-in').addEventListener('click', function (e) {
            var currentZoom = manager.samplesPerPixel;
            var newZoom = currentZoom / 2;

            manager.samplesPerPixel = newZoom;
            //drawTimeLine(newZoom, audioContext.sampleRate, width, height, manager.scrollPosition);

            sppDiv.innerText = 'Samples per pixel: ' + manager.samplesPerPixel;
            scroller.style.width = manager.getScrollWidth() + 'px';

            const ids = buffers.slice(lastStartIndex, lastStartIndex + fitInElement)
                .map(b => b.id);
            manager.draw(ids);
        });

        document.getElementById('zoom-out').addEventListener('click', function (e) {
            var currentZoom = manager.samplesPerPixel;
            var newZoom = currentZoom * 2;

            manager.samplesPerPixel = newZoom;
            //drawTimeLine(newZoom, audioContext.sampleRate, width, height, manager.scrollPosition);

            sppDiv.innerText = 'Samples per pixel: ' + manager.samplesPerPixel;
            scroller.style.width = manager.getScrollWidth() + 'px';

            const ids = buffers.slice(lastStartIndex, lastStartIndex + fitInElement)
                .map(b => b.id);
            manager.draw(ids);
        });
    </script>
</body>

</html>